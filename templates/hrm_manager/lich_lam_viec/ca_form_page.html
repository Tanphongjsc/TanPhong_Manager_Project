{% extends "base.html" %}
{% load static %}

{% block title %}{{ title|default:"Thiết kế ca làm việc" }}{% endblock %}

{% block content %}
<div class="w-full pb-20">
    {% include "components/breadcrumb.html" with breadcrumb_items=breadcrumbs %}

    <div class="bg-white shadow-sm rounded-lg mt-4 mx-4">
        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center">
            <h1 id="page-title" class="text-xl font-bold text-slate-900">
                {{ title|default:"Thêm mới ca làm việc" }}
            </h1>
        </div>

        <form id="ca-form" class="p-6 space-y-8">
            {% csrf_token %}

            {# ===================== THIẾT LẬP CƠ BẢN ===================== #}
            <div class="space-y-4">
                {% include "components/section_header.html" with title="Thiết lập cơ bản" icon_class="fas fa-info-circle" %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% include "components/form_field_text.html" with label="Tên ca làm việc" name="tencalamviec" required=True placeholder="VD: Ca Hành Chính" %}

                    {% include "components/form_field_text.html" with label="Mã ca" name="macalamviec" required=True placeholder="VD: HC01" %}
                </div>
            </div>

            {# ===================== THIẾT LẬP CA CHI TIẾT ===================== #}
            <div class="space-y-4">
                {% include "components/section_header.html" with title="Thiết lập ca chi tiết" icon_class="fas fa-cogs" %}

                <div class="space-y-2">
                    <div class="flex items-center space-x-8">
                        <label class="text-sm font-medium text-slate-700">Thời gian chấm công:</label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="loaichamcong" value="CO_DINH" checked class="text-green-600 focus:ring-green-500 w-4 h-4">
                            <span class="ml-2 text-sm text-slate-700">Cố định</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="loaichamcong" value="LINH_DONG" class="text-green-600 focus:ring-green-500 w-4 h-4">
                            <span class="ml-2 text-sm text-slate-700">Linh động</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="loaichamcong" value="TU_DO" class="text-green-600 focus:ring-green-500 w-4 h-4">
                            <span class="ml-2 text-sm text-slate-700">Tự do</span>
                        </label>
                    </div>

                    <p id="desc-co-dinh" class="text-sm text-slate-500 italic ml-[130px]">
                        CBNV phải đi làm cố định trong một khung giờ vào ca, ra ca cụ thể
                    </p>
                    <p id="desc-linh-dong" class="text-sm text-slate-500 italic ml-[130px] hidden">
                        Cho phép CBNV linh động trong khung giờ vào, ra ca, chỉ cần đủ tổng giờ làm
                    </p>
                    <p id="desc-tu-do" class="text-sm text-slate-500 italic ml-[130px] hidden">
                        Cho phép CBNV tự do tổng giờ làm, chỉ cần chấm công hoặc không cần chấm công
                    </p>
                </div>

                {# ----------------- BLOCK CỐ ĐỊNH ----------------- #}
                <div id="block-co-dinh" class="shift-config-block space-y-6 p-6 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex items-center space-x-6">
                        <span class="text-sm font-medium text-slate-700 w-48">Số khung giờ trong ca:</span>
                        <div class="flex space-x-6">
                            {% for i in "123" %}
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="sokhunggio" value="{{ i }}" {% if i == "1" %}checked{% endif %} class="text-green-600 focus:ring-green-500 w-4 h-4">
                                <span class="ml-2 text-sm text-slate-700">{{ i }} khung</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="flex items-center space-x-6">
                        <span class="text-sm font-medium text-slate-700 w-48">Số lần chấm công trong ngày:</span>
                        <div class="flex space-x-6" id="timekeeping-count-options"></div>
                    </div>

                    <div class="text-sm font-medium text-slate-700 bg-green-50 p-3 rounded border border-green-200 inline-block">
                        Tổng thời gian làm việc của ca:
                        <span id="total-work-time" class="text-green-700 font-bold ml-1">00 giờ 00 phút</span>
                    </div>

                    <div id="segments-container" class="space-y-6"></div>

                    <div id="lunch-break-section" class="border-t border-slate-200 pt-4 hidden">
                        <div class="flex items-center mb-3">
                            {% include "components/form_toggle.html" with id="has-lunch-break" name="" label="Nghỉ giữa giờ (nghỉ trưa)" extra_input_class="status-toggle" %}
                        </div>
                        <div id="lunch-time-inputs" class="flex items-center space-x-4 ml-14 hidden">
                            <div class="w-32">
                                <input type="text" name="batdaunghigiuaca" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center bg-white" placeholder="12:00" maxlength="5">
                            </div>
                            <span class="text-slate-400">-</span>
                            <div class="w-32">
                                <input type="text" name="ketthucnghigiuaca" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center bg-white" placeholder="13:00" maxlength="5">
                            </div>
                            <span class="text-xs text-slate-500 italic">Nghỉ giữa giờ sẽ không tính là giờ làm việc</span>
                        </div>
                    </div>
                </div>

                {# ----------------- BLOCK LINH ĐỘNG ----------------- #}
                <div id="block-linh-dong" class="shift-config-block hidden p-6 bg-slate-50 rounded-lg border border-slate-200 space-y-6">
                    <div class="text-sm font-medium text-slate-700 bg-green-50 p-3 rounded border border-green-200 inline-block">
                        Tổng thời gian làm việc của ca:
                        <span id="ld-total-work-time" class="text-green-700 font-bold ml-1">00 giờ 00 phút</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-bold text-slate-700 w-32">
                                    Giờ bắt đầu <span class="text-red-500">*</span>
                                </label>
                                <div class="w-36">
                                    <input type="text" name="ld_batdau" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-bold text-slate-700 bg-white" placeholder="08:00" maxlength="5">
                                </div>
                            </div>
                            <div class="pl-4 border-l-2 border-slate-200 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-600">Không ghi nhận chấm công nếu đến muộn hơn (phút)</span>
                                    <input type="number" name="ld_late_cutoff" class="w-24 px-2 py-1 text-sm border border-slate-300 rounded text-right" placeholder="∞">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-600">Thời gian cho phép chấm công sớm nhất</span>
                                    <div class="w-24">
                                        <input type="text" name="ld_early_in" class="time-input w-full px-2 py-1 text-sm border border-slate-300 rounded text-center bg-white" placeholder="--:--">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-bold text-slate-700 w-32">
                                    Giờ kết thúc <span class="text-red-500">*</span>
                                </label>
                                <div class="w-36">
                                    <input type="text" name="ld_ketthuc" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-bold text-slate-700 bg-white" placeholder="17:00" maxlength="5">
                                </div>
                            </div>
                            <div class="pl-4 border-l-2 border-slate-200 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-600">Không ghi nhận chấm công nếu về sớm hơn (phút)</span>
                                    <input type="number" name="ld_early_cutoff" class="w-24 px-2 py-1 text-sm border border-slate-300 rounded text-right" placeholder="∞">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-600">Thời gian cho phép về muộn nhất</span>
                                    <div class="w-24">
                                        <input type="text" name="ld_late_out" class="time-input w-full px-2 py-1 text-sm border border-slate-300 rounded text-center bg-white" placeholder="--:--">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <h4 class="text-sm font-bold text-slate-700 mb-3">Thời gian linh động</h4>
                        <div class="grid grid-cols-1 gap-4 bg-white p-4 rounded border border-slate-200">
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-600 min-w-[180px]">Có thể đến muộn nhất</span>
                                <input type="number" name="ld_flex_late" class="w-24 px-3 py-1.5 border border-slate-300 rounded text-right focus:border-green-500 focus:ring-1 focus:ring-green-500" placeholder="0">
                                <span class="text-sm text-slate-500">phút</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-1 ml-48 italic">
                                Đến muộn bao nhiêu phút thì nhân viên cần phải ở lại muộn bấy nhiêu phút để đủ công
                            </p>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-slate-600 min-w-[180px]">Có thể đến sớm nhất</span>
                                <input type="number" name="ld_flex_early" class="w-24 px-3 py-1.5 border border-slate-300 rounded text-right" placeholder="0">
                                <span class="text-sm text-slate-500">phút</span>
                            </div>
                            <p class="text-xs text-slate-400 mt-1 ml-48 italic">
                                Đến sớm bao nhiêu phút thì nhân viên có thể về sớm bấy nhiêu phút để đủ công
                            </p>
                        </div>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <div class="flex items-center mb-2">
                            {% include "components/form_toggle.html" with id="ld-has-lunch-break" name="" label="Nghỉ giữa giờ" extra_input_class="status-toggle" %}
                        </div>
                        <div id="ld-lunch-time-inputs" class="flex items-center space-x-4 ml-14 mt-2 hidden">
                            <div class="w-32">
                                <input type="text" name="ld_batdaunghi" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center bg-white" placeholder="12:00" maxlength="5">
                            </div>
                            <span class="text-slate-400">-</span>
                            <div class="w-32">
                                <input type="text" name="ld_ketthucnghi" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center bg-white" placeholder="13:00" maxlength="5">
                            </div>
                            <span class="text-xs text-slate-500 italic">Nghỉ giữa giờ sẽ không tính là giờ làm việc</span>
                        </div>
                    </div>
                </div>

                {# ----------------- BLOCK TỰ DO ----------------- #}
                <div id="block-tu-do" class="shift-config-block hidden p-6 bg-slate-50 rounded-lg border border-slate-200 space-y-6">
                    <div class="bg-white p-6 rounded border border-slate-200 space-y-6">
                        <div class="flex items-center">
                            <label class="text-sm font-bold text-slate-700 w-32">
                                Giờ bắt đầu: <span class="text-red-500">*</span>
                            </label>
                            <div class="flex items-center gap-3">
                                <div class="w-32">
                                    <input type="text" name="td_batdau" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-medium bg-white" maxlength="5" placeholder="00:00">
                                </div>
                                <span class="text-slate-400">-</span>
                                <div class="w-32">
                                    <input type="text" name="td_ketthuc" class="time-input w-full px-3 py-2 border border-slate-300 rounded-lg text-center font-medium bg-white" maxlength="5" placeholder="23:59">
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center">
                            {% include "components/form_toggle.html" with id="toggle-yeucau" name="yeucauchamcong" label="Yêu cầu chấm công" extra_input_class="status-toggle" %}
                        </div>

                        <div id="min-work-time-container" class="hidden flex items-center animate-fade-in">
                            <label class="text-sm font-bold text-slate-700 w-48">
                                Thời lượng tối thiểu phải làm <span class="text-red-500">*</span>
                            </label>
                            <input type="number" name="thoigianlamviectoithieu" class="w-32 px-3 py-2 border border-slate-300 rounded-lg" placeholder="180">
                            <span class="ml-2 text-sm text-slate-600">phút</span>
                        </div>
                    </div>
                </div>
            </div>

            {# ===================== THIẾT LẬP CÔNG ===================== #}
            <div class="space-y-4">
                {% include "components/section_header.html" with title="Thiết lập công" icon_class="fas fa-calculator" %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">
                            Công của ca <span class="text-red-500">*</span>
                        </label>
                        <input type="number" step="0.1" name="congcuaca" id="total-workday" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 transition-all" placeholder="1.0">
                    </div>
                    <div class="pt-6">
                        {% include "components/form_toggle.html" with id="khongcancheckout" name="khongcancheckout" label="Không cần Checkout" extra_input_class="status-toggle" description="Hệ thống tự động ghi nhận giờ checkout là giờ kết thúc của ca làm việc" %}
                    </div>
                </div>
            </div>

            {# ===================== FOOTER CỐ ĐỊNH ===================== #}
            {% include "components/form_footer_fixed.html" with cancel_url=cancel_url submit_id="btn-save" submit_text="Lưu lại" %}
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/components/custom_time_picker.js' %}"></script>
<script src="{% static 'js/utils/base_form_manager.js' %}"></script>
<script src="{% static 'js/lich_lam_viec/ca_form.js' %}"></script>
{% endblock %}