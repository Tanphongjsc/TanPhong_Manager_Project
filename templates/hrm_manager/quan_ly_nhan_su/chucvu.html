{% extends "base.html" %}
{% load static %}

{% block title %}Quản lý Chức vụ{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 h-full flex flex-col">
    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

    {% include "hrm_manager/components/toolbar.html" with search_id="search-input" placeholder="Tìm kiếm theo Tên Vị Trí..." show_add_btn=True add_btn_id="btn-add-new" %}

    {% with headers='<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Mã Chức Vụ</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tên Vị Trí</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Trạng Thái</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ngày tạo</th>' %}
        {% include "hrm_manager/components/table_wrapper.html" with table_id="positions-table" headers_html=headers %}
    {% endwith %}
    
    {% include "hrm_manager/components/pagination.html" %}
</div>

<div id="position-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 transition-opacity duration-200 opacity-0">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col transform transition-transform duration-200 scale-95 modal-content">
        <div class="p-4 sm:p-5 border-b flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-semibold text-slate-800" id="position-modal-title">Quản lý chức vụ</h3>
            <button type="button" class="text-slate-400 hover:text-slate-600 transition-colors btn-close-modal"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="position-form" class="p-4 sm:p-5 space-y-4 overflow-y-auto">
            <input type="hidden" id="form-position-id" name="id">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Tên Vị Trí <span class="text-red-500">*</span></label>
                <input type="text" id="form-tenvitricongviec" name="tenvitricongviec" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Mã Chức Vụ <span class="text-red-500">*</span></label>
                <input type="text" id="form-machucvu" name="machucvu" required class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500 bg-slate-50">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Trạng Thái</label>
                <select id="form-trangthai" name="trangthai" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm text-sm">
                    <option value="active">Đang hoạt động</option>
                    <option value="inactive">Ngưng hoạt động</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Ghi Chú</label>
                <textarea id="form-ghichu" name="ghichu" rows="3" class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm text-sm"></textarea>
            </div>
        </form>
        <div class="p-4 sm:p-5 border-t flex justify-end gap-3 bg-slate-50 rounded-b-lg">
            <button type="button" class="px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors btn-cancel-modal">Hủy</button>
            <button type="submit" form="position-form" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700 transition-colors">Lưu thay đổi</button>
        </div>
    </div>
</div>

{% include "hrm_manager/components/modal_confirm.html" with modal_id="delete-modal" title="Xóa chức vụ" content="Bạn có chắc chắn muốn xóa chức vụ này?" btn_confirm_id="btn-confirm-delete" %}

{% include "hrm_manager/components/toast.html" %}
{% endblock content %}

{% block scripts %}
<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/TableManager.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const API_URL = "/hrm/to-chuc-nhan-su/api/v1/chuc-vu/";
    
    // DOM Elements
    const positionModalEl = document.getElementById('position-modal');
    const deleteModalEl = document.getElementById('delete-modal');
    const positionForm = document.getElementById('position-form');
    let currentDeleteId = null;

    // Trạng thái modal
    let isEditMode = false;          // true khi cập nhật
    let autoCodeEnabled = true;      // chỉ tự sinh mã ở chế độ tạo mới

    // 1. Init Table
    const tableManager = new TableManager({
        apiEndpoint: API_URL,
        tableBody: document.querySelector('#positions-table tbody'),
        paginationContainer: document.querySelector('.pagination-container'),
        searchInput: document.getElementById('search-input'),
        onRenderRow: (pos) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 transition-colors';
            tr.dataset.position = JSON.stringify(pos);
            
            const statusClass = pos.trangthai === 'active' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-700';
            const statusText = pos.trangthai === 'active' ? 'Đang hoạt động' : 'Ngưng hoạt động';

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${pos.machucvu || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${pos.tenvitricongviec || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${statusText}</span></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${CommonUtils.DateUtils.format(pos.created_at)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                    <button class="btn-edit text-blue-600 hover:text-blue-900 p-1" data-id="${pos.id}"><i class="fas fa-pen"></i></button>
                    <button class="btn-delete text-red-600 hover:text-red-900 p-1" data-id="${pos.id}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            return tr;
        },
        onError: (err) => CommonUtils.Toast.error(err.message)
    });

    // 2. Form Handling
    function openPositionModal(positionData = null) {
        CommonUtils.Form.reset(positionForm);
        const titleEl = document.getElementById('position-modal-title');
        const codeInput = document.getElementById('form-machucvu');
        const nameInput = document.getElementById('form-tenvitricongviec');
        const idInput = document.getElementById('form-position-id');

        isEditMode = !!positionData;
        autoCodeEnabled = !isEditMode; // chỉ tự sinh ở chế độ tạo mới

        if (isEditMode) {
            titleEl.textContent = 'Cập nhật chức vụ';
            CommonUtils.Form.setData(positionForm, positionData);
            codeInput.readOnly = true;
            codeInput.classList.add('bg-slate-100');
        } else {
            titleEl.textContent = 'Tạo mới chức vụ';
            idInput.value = '';                // chắc chắn xóa id cũ
            codeInput.value = '';              // xóa mã cũ để generate lại
            codeInput.readOnly = false;
            codeInput.classList.remove('bg-slate-100');
            autoCodeEnabled = true;
        }
        CommonUtils.Modal.open(positionModalEl);
        // Focus tên vị trí khi tạo mới
        if (!isEditMode) nameInput.focus();
    }

    // Event: Add New
    const btnAdd = document.getElementById('btn-add-new');
    if(btnAdd) btnAdd.addEventListener('click', () => openPositionModal());

    // Event: Submit Form
    positionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = positionForm.querySelector('button[type="submit"]') ||
                          document.querySelector('button[type="submit"][form="position-form"]');
        
        await CommonUtils.Loading.execute(submitBtn, async () => {
            const data = CommonUtils.Form.getData(positionForm);
            const id = data.id;
            const method = id ? 'put' : 'post';
            const url = id ? `${API_URL}${id}/` : API_URL;
            
            await CommonUtils.API[method](url, data);
            CommonUtils.Toast.success(id ? 'Cập nhật thành công!' : 'Thêm mới thành công!');
            CommonUtils.Modal.close(positionModalEl);
            tableManager.refresh();
        });
    });

    // 3. Auto Generate Code
    const nameInput = document.getElementById('form-tenvitricongviec');
    const codeInput = document.getElementById('form-machucvu');

    if (nameInput && codeInput) {
        const generateCode = CommonUtils.debounce(() => {
            if (!autoCodeEnabled) return; // chỉ chạy khi cho phép
            const val = nameInput.value.trim();
            codeInput.value = val ? CommonUtils.StringUtils.generatePositionCode(val) : '';
        }, 200);

        nameInput.addEventListener('input', generateCode);

        // Nếu user tự sửa mã ở chế độ tạo mới -> tắt auto để không ghi đè nữa
        codeInput.addEventListener('input', () => {
            if (!isEditMode) autoCodeEnabled = false;
        });
    }

    // 4. Close Modal Events
    document.querySelectorAll('.btn-close-modal, .btn-cancel-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.fixed');
            CommonUtils.Modal.close(modal);
        });
    });
    CommonUtils.Modal.setupBackdropClose(positionModalEl);
    CommonUtils.Modal.setupBackdropClose(deleteModalEl);

    // 5. Table Actions (Edit/Delete)
    document.querySelector('#positions-table tbody').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.btn-edit');
        if (editBtn) {
            const row = editBtn.closest('tr');
            if (row?.dataset.position) openPositionModal(JSON.parse(row.dataset.position));
        }

        const deleteBtn = e.target.closest('.btn-delete');
        if (deleteBtn) {
            currentDeleteId = deleteBtn.dataset.id;
            CommonUtils.Modal.open(deleteModalEl);
        }
    });

    // 6. Confirm Delete
    document.getElementById('btn-confirm-delete').addEventListener('click', async function() {
        if (!currentDeleteId) return;
        await CommonUtils.Loading.execute(this, async () => {
            await CommonUtils.API.delete(`${API_URL}${currentDeleteId}/`);
            CommonUtils.Toast.success('Đã xóa thành công!');
            CommonUtils.Modal.close(deleteModalEl);
            tableManager.refresh();
        }, 'Đang xóa...');
    });
});
</script>
{% endblock scripts %}