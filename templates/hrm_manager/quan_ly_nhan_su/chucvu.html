{% extends "base.html" %}
{% load static %}

{% block title %}Quản lý Chức vụ{% endblock %}

{% block content %}
<div class="flex flex-col h-full space-y-4">
    <!-- Breadcrumb -->
    {% include "components/breadcrumb.html" with breadcrumb_items=breadcrumbs %}

    <div class="bg-white rounded-lg shadow-sm p-1 sm:p-2 h-full flex flex-col">
        <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

        <!-- Toolbar -->
        <!-- create_onclick gọi hàm openSidebar được kế thừa từ BaseCRUDManager -->
        {% include "components/toolbar.html" with search_id="search-input" placeholder="Tìm kiếm theo Tên Vị Trí..." show_add_btn=True create_text="Thêm chức vụ" create_onclick="window.ChucVuManager.openSidebar('create')" %}

        <!-- Table -->
        {% with headers='<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Mã Chức Vụ</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Tên Vị Trí</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Trạng Thái</th><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ngày tạo</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Thao tác</th>' %}
            {% include "components/table_wrapper.html" with table_id="positions-table" tbody_id="table-body" headers_html=headers %}
        {% endwith %}
        
        <!-- Pagination -->
        {% include "components/pagination.html" %}
    </div>
</div>

<!-- Sidebar Form -->
<!-- ID ở đây phải khớp với config trong JS -->
{% include "components/crud_sidebar.html" with sidebar_id="chucvu-sidebar" overlay_id="chucvu-sidebar-overlay" form_id="chucvu-form" form_fields_template="hrm_manager/quan_ly_nhan_su/partials/chucvu_form.html" title="Thông tin chức vụ" submit_text="Lưu thông tin" %}

{% endblock content %}

{% block scripts %}
<script>
/**
 * Class quản lý Chức vụ
 * Kế thừa BaseCRUDManager để tận dụng logic có sẵn
 */
class ChucVuManager extends BaseCRUDManager {
    constructor() {
        // 1. Config cho Form Sidebar (CRUD)
        super({
            // Các ID này phải khớp với HTML include ở trên
            sidebarId: 'chucvu-sidebar',
            overlayId: 'chucvu-sidebar-overlay',
            formId: 'chucvu-form',
            codeField: 'machucvu', // ID input mã để BaseManager tự xử lý readonly khi edit
            
            // ✨ [MỚI] Chỉ cần thêm config này để kích hoạt tính năng
            autoCode: {
                sourceField: 'tenvitricongviec', // Input nhập tên
                targetField: 'machucvu'          // Input nhận mã (nhập vào machucvu)
            },

            // API endpoints
            apiUrls: {
                detail: (id) => `/hrm/to-chuc-nhan-su/api/v1/chuc-vu/${id}/`,
                create: '/hrm/to-chuc-nhan-su/api/v1/chuc-vu/',
                update: (id) => `/hrm/to-chuc-nhan-su/api/v1/chuc-vu/${id}/`,
                delete: (id) => `/hrm/to-chuc-nhan-su/api/v1/chuc-vu/${id}/`,
            },
            
            entityName: 'chức vụ',
            confirmDeleteMessage: 'Bạn có chắc chắn muốn xóa chức vụ này?',

            // 2. Callback: Refresh bảng sau khi lưu thành công
            onRefreshTable: () => this.tableManager && this.tableManager.refresh(),

            // 3. Map data từ API vào Form khi sửa
            fillFormData: (data) => {
                const form = document.getElementById('chucvu-form');
                if (!form) return;
                
                // Helper gán giá trị an toàn
                const setVal = (name, val) => {
                    const el = form.querySelector(`[name="${name}"]`);
                    if (el) el.value = val || '';
                };

                setVal('id', data.id);
                setVal('tenvitricongviec', data.tenvitricongviec);
                setVal('machucvu', data.machucvu);
                setVal('trangthai', data.trangthai);
                setVal('ghichu', data.ghichu);
            },
            
            // 4. Reset form khi mở mode Add (BaseManager đã có mặc định, nhưng có thể override nếu cần custom)
            onResetForm: () => {
                const form = document.getElementById('chucvu-form');
                if (form) {
                    form.reset();
                    form.querySelector('[name="id"]').value = '';
                    // Reset trạng thái readonly của mã chức vụ (nếu BaseManager chưa xử lý)
                    const codeInput = form.querySelector('[name="machucvu"]');
                    if (codeInput) {
                        codeInput.readOnly = false;
                        codeInput.classList.remove('bg-slate-100');
                    }
                }
            }
        });

        this.tableManager = null;
        this.autoCodeEnabled = true;
    }

    init() {
        super.init(); 
        this.initTable();
    }

    initTable() {
        // Config cho TableManager
        this.tableManager = new TableManager({
            tableBody: document.getElementById('table-body'),
            paginationContainer: document.querySelector('.pagination-container'),
            searchInput: document.getElementById('search-input'),
            
            // API Endpoint lấy danh sách
            apiEndpoint: "/hrm/to-chuc-nhan-su/api/v1/chuc-vu/",
            
            // Render từng dòng
            onRenderRow: (item) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-200';
                
                const statusHtml = item.trangthai === 'active' 
                    ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Đang hoạt động</span>'
                    : '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">Ngừng hoạt động</span>';
                
                const createdDate = AppUtils.DateUtils.format(item.created_at);

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${item.machucvu || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                        <a href="javascript:void(0);" onclick="window.ChucVuManager.openSidebar('edit', ${item.id})" class="hover:text-blue-600">
                            ${item.tenvitricongviec || ''}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusHtml}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${createdDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button type="button" class="text-blue-600 hover:text-blue-900 p-1 transition-colors" onclick="window.ChucVuManager.openSidebar('edit', ${item.id})"><i class="fas fa-pen"></i></button>
                        <button type="button" class="text-red-600 hover:text-red-900 p-1 transition-colors" onclick="window.ChucVuManager.deleteItem(${item.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                return tr;
            }
        });
    }
}

// Khởi tạo
document.addEventListener('DOMContentLoaded', () => {
    window.ChucVuManager = new ChucVuManager();
    window.ChucVuManager.init();
});
</script>
{% endblock scripts %}