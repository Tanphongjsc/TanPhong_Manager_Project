{% extends "base.html" %}
{% load static %}

{% block title %}Cây nhân sự & Danh sách{% endblock %}

{% block styles %}
<style>
    /* Layout & Animation */
    .org-layout { display: grid; grid-template-columns: 1fr; gap: 1rem; height: calc(100vh - 130px); }
    @media (min-width: 1024px) { .org-layout { grid-template-columns: 320px 1fr; } }
    
    #tree-sidebar { transition: transform 0.3s ease-in-out; }
    @media (max-width: 1023px) {
        #tree-sidebar { position: fixed; inset: 0; width: 100%; z-index: 50; transform: translateX(-100%); }
        #tree-sidebar.open { transform: translateX(0); }
    }
    /* Custom Scrollbar */
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full space-y-4">
    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
    {% include "components/breadcrumb.html" with breadcrumb_items=breadcrumbs %}

    <div class="org-layout relative">
        <div id="sidebar-overlay" onclick="window.TreeManager.toggleSidebar(false)" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden transition-opacity"></div>

        <aside id="tree-sidebar" class="bg-white shadow-sm border border-slate-200 rounded-lg flex flex-col h-full overflow-hidden">
            <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-slate-800">Cấu trúc tổ chức</h3>
                <div class="flex items-center gap-2">
                    <button onclick="window.CompanyManager.openAddCompany()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded flex items-center gap-1 transition-colors">
                        <i class="fas fa-plus"></i> <span class="hidden sm:inline">Công ty</span>
                    </button>
                    <button onclick="window.TreeManager.toggleSidebar(false)" class="lg:hidden w-8 h-8 flex items-center justify-center text-slate-400 hover:bg-slate-100 rounded-full">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="p-3 border-b border-slate-50 relative">
                <i class="fas fa-search absolute left-6 top-5 text-slate-400 text-xs"></i>
                <input type="text" id="tree-search-input" class="w-full pl-8 pr-3 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Tìm bộ phận...">
            </div>

            <div class="flex-1 custom-scroll p-2 overflow-y-auto" id="org-tree-container">
                <div id="view-all-employees" class="flex items-center gap-3 p-2.5 rounded-md cursor-pointer bg-blue-50 text-blue-700 font-medium mb-2 hover:bg-blue-100 border border-blue-100 transition-colors">
                    <i class="fas fa-users"></i> <span class="flex-1 text-sm">Tất cả nhân viên</span>
                </div>
                <ul id="tree-root" class="space-y-1"></ul>
            </div>
        </aside>

        <main class="bg-white shadow-sm border border-slate-200 rounded-lg flex flex-col h-full overflow-hidden">
            <div class="shrink-0 px-4 py-3 border-b border-slate-200 flex items-center justify-between bg-slate-50/50">
                <div class="flex items-center gap-3">
                    <button onclick="window.TreeManager.toggleSidebar(true)" class="lg:hidden text-slate-500 hover:bg-slate-100 p-1 rounded">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 class="text-base font-bold text-slate-800" id="list-title">Bảng nhân viên</h2>
                </div>
                <button onclick="window.EmployeeManager.openSidebar('create')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded flex items-center gap-1 shadow-sm transition-colors">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">Thêm mới</span>
                </button>
            </div>

            <div class="flex-1 flex flex-col p-2 overflow-y-auto relative" id="main-content-body">
                {% include "components/toolbar.html" with search_id="search-input" search_placeholder="Tìm tên, mã NV..." filter_form_id="filter-form" filter_options=status_list_nv filter_field="trangthainv" filter_label="Tất cả trạng thái" filter_template="hrm_manager/quan_ly_nhan_su/partials/nhanvien_extra_filters.html" %}

                {% with headers='<th class="px-3 py-2 text-left uppercase font-semibold text-xs">Nhân viên</th><th class="px-3 py-2 text-left uppercase font-semibold text-xs w-24">Mã NV</th><th class="px-3 py-2 text-left uppercase font-semibold text-xs w-32">Trạng thái</th><th class="px-3 py-2 text-left uppercase font-semibold text-xs">Bộ phận</th><th class="px-3 py-2 text-left uppercase font-semibold text-xs w-28">Ngày vào</th>' %}
                    {% include "components/table_wrapper.html" with table_id="employee-table" tbody_id="table-body" headers_html=headers show_checkbox=True select_all_id="select-all-checkbox" %}
                {% endwith %}

                {% include "components/pagination.html" %}
                {% include "components/bulk_actions.html" with id="bulk-actions" container_id="bulk-actions" show_delete=True show_export=True %}
            </div>
        </main>
    </div>
</div>

{% include "components/crud_sidebar.html" with sidebar_id="employee-sidebar" overlay_id="employee-sidebar-overlay" form_id="employee-form" form_fields_template="hrm_manager/quan_ly_nhan_su/partials/nhanvien_form.html" title="Thông tin nhân viên" submit_text="Lưu nhân viên" %}
{% include "components/crud_sidebar.html" with sidebar_id="company-sidebar" overlay_id="company-sidebar-overlay" form_id="company-form" form_fields_template="hrm_manager/quan_ly_nhan_su/partials/congty_form.html" title="Thông tin công ty" submit_text="Lưu công ty" %}
{% include "components/crud_sidebar.html" with sidebar_id="dept-sidebar" overlay_id="dept-sidebar-overlay" form_id="dept-form" form_fields_template="hrm_manager/quan_ly_nhan_su/partials/phongban_form.html" title="Cập nhật tổ chức" submit_text="Lưu thay đổi" %}

<template id="tree-node-template">
    <li class="pl-4 border-l border-slate-200 ml-2.5">
        <div class="tree-item group flex items-center justify-between p-1.5 rounded-md cursor-pointer hover:bg-slate-50 border border-transparent hover:border-slate-200 transition-all mb-0.5">
            <div class="flex items-center gap-2 overflow-hidden min-w-0">
                <button class="tree-toggle invisible w-5 h-5 flex items-center justify-center hover:bg-slate-200 rounded text-slate-400 transition-transform">
                    <i class="fas fa-chevron-right text-[10px]"></i>
                </button>
                <i class="tree-icon text-sm flex-shrink-0"></i>
                <span class="tree-name text-sm text-slate-700 truncate select-none"></span>
            </div>
            <div class="hidden group-hover:flex items-center bg-white rounded shadow-sm border border-slate-100 ml-2">
                <button class="btn-add-sub p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50" title="Thêm cấp con"><i class="fas fa-plus text-xs"></i></button>
                <button class="btn-edit p-1.5 text-slate-400 hover:text-green-600 hover:bg-green-50" title="Sửa"><i class="fas fa-pen text-xs"></i></button>
                <button class="btn-delete p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50" title="Xóa"><i class="fas fa-trash text-xs"></i></button>
            </div>
        </div>
        <ul class="tree-children hidden"></ul>
    </li>
</template>

<input type="hidden" id="url-emp-detail-pattern" value="{% url 'hrm:to_chuc_nhan_su:cay_nhan_su_nhan_vien_index' 0 %}">
{% endblock content %}

{% block scripts %}
<script src="{% static 'js/quan_ly_nhan_su/cay_nhan_su.js' %}"></script>
{% endblock scripts %}